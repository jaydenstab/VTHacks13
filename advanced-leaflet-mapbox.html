<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseNYC - Advanced Leaflet + Mapbox GL</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Mapbox GL CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1d1d1f;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 2000;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #1d1d1f;
            margin: 0;
        }

        .subtitle {
            font-size: 14px;
            color: #86868b;
            margin: 0;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-button:hover {
            background: rgba(0, 122, 255, 0.1);
            transform: translateY(-2px);
        }

        .control-button.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }

        .map-container {
            flex: 1;
            position: relative;
            margin-top: 80px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .events-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .events-title {
            font-size: 20px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.8);
            outline: none;
            transition: all 0.2s ease;
        }

        .search-box:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }

        .filter-button:hover {
            background: rgba(0, 122, 255, 0.1);
            transform: translateY(-1px);
        }

        .filter-button.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
        }

        .event-item {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .event-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .event-item:hover {
            background: rgba(0, 122, 255, 0.05);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .event-item:hover::before {
            transform: scaleX(1);
        }

        .event-category {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-music { background: linear-gradient(135deg, #FF3B30, #FF6B6B); color: white; }
        .category-art { background: linear-gradient(135deg, #007AFF, #5AC8FA); color: white; }
        .category-food { background: linear-gradient(135deg, #34C759, #30D158); color: white; }
        .category-comedy { background: linear-gradient(135deg, #FF9500, #FFB84D); color: white; }
        .category-free { background: linear-gradient(135deg, #FFCC00, #FFD60A); color: #1d1d1f; }

        .event-title {
            font-size: 16px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .event-details {
            font-size: 13px;
            color: #86868b;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #86868b;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .legend-title {
            font-size: 16px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #86868b;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .stats-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-width: 200px;
        }

        .stats-title {
            font-size: 16px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-label {
            color: #86868b;
        }

        .stat-value {
            font-weight: 600;
            color: #1d1d1f;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 32px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e5e7;
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .events-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: auto;
                border-radius: 20px 20px 0 0;
                max-height: 60vh;
            }
            
            .legend, .stats-panel {
                display: none;
            }
            
            .header {
                padding: 0 16px;
            }
            
            .title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-section">
                <div class="logo">üóΩ</div>
                <div>
                    <h1 class="title">PulseNYC</h1>
                    <p class="subtitle">Advanced Interactive Event Map</p>
                </div>
            </div>
            
            <div class="controls">
                <button class="control-button active" onclick="switchMap('leaflet')" id="leafletBtn">
                    üó∫Ô∏è Leaflet
                </button>
                <button class="control-button" onclick="switchMap('mapbox')" id="mapboxBtn">
                    üåç Mapbox GL
                </button>
                <button class="control-button" onclick="toggle3D()" id="3dBtn">
                    üèóÔ∏è 3D View
                </button>
                <button class="control-button" onclick="toggleAnimations()" id="animBtn">
                    ‚ú® Animations
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3 style="margin: 0 0 8px 0; color: #1d1d1f;">Loading Advanced Map...</h3>
                <p style="margin: 0; font-size: 14px; color: #86868b;">Initializing Leaflet + Mapbox GL integration</p>
            </div>
            
            <div class="stats-panel">
                <div class="stats-title">üìä Map Stats</div>
                <div class="stat-item">
                    <span class="stat-label">Map Type:</span>
                    <span class="stat-value" id="mapType">Leaflet</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Events:</span>
                    <span class="stat-value" id="eventCount">5</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">3D Mode:</span>
                    <span class="stat-value" id="3dStatus">Off</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Animations:</span>
                    <span class="stat-value" id="animStatus">On</span>
                </div>
            </div>
            
            <div class="events-panel">
                <h2 class="events-title">üéØ NYC Events</h2>
                
                <input type="text" class="search-box" placeholder="Search events, locations, or categories..." id="searchBox">
                
                <div class="filter-buttons">
                    <button class="filter-button active" onclick="filterEvents('all')">All</button>
                    <button class="filter-button" onclick="filterEvents('music')">üéµ Music</button>
                    <button class="filter-button" onclick="filterEvents('art')">üé® Art</button>
                    <button class="filter-button" onclick="filterEvents('food')">üçΩÔ∏è Food</button>
                    <button class="filter-button" onclick="filterEvents('comedy')">üòÇ Comedy</button>
                    <button class="filter-button" onclick="filterEvents('free')">üÜì Free</button>
                </div>

                <div id="eventsList">
                    <!-- Events will be populated by JavaScript -->
                </div>
            </div>

            <div class="legend">
                <div class="legend-title">üé® Event Types</div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: linear-gradient(135deg, #FF3B30, #FF6B6B);"></div>
                    <span>Music Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: linear-gradient(135deg, #007AFF, #5AC8FA);"></div>
                    <span>Art & Culture</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: linear-gradient(135deg, #34C759, #30D158);"></div>
                    <span>Food & Drink</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: linear-gradient(135deg, #FF9500, #FFB84D);"></div>
                    <span>Comedy & Entertainment</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: linear-gradient(135deg, #FFCC00, #FFD60A);"></div>
                    <span>Free Events</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Mapbox GL JavaScript -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <script>
        // Your Mapbox token
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiZGV2a3VtYXIxMjMiLCJhIjoiY21nMXZpdTE1MHQwejJub2ZudWd3ZGZ0ZSJ9.Ed8Xd2_5aBZzthiEhdXZgA';
        
        // Event data
        const events = [
            {
                id: 'jazz',
                name: 'Jazz Night at Blue Note',
                category: 'music',
                lat: 40.7306,
                lng: -74.0023,
                address: '131 W 3rd St, New York, NY 10012',
                time: '8:00 PM',
                price: '$25',
                description: 'An evening of smooth jazz featuring local artists',
                popularity: 85
            },
            {
                id: 'gallery',
                name: 'Art Gallery Opening',
                category: 'art',
                lat: 40.7256,
                lng: -73.9943,
                address: '123 Spring St, New York, NY 10012',
                time: '6:00 PM',
                price: 'Free',
                description: 'Contemporary art exhibition opening reception',
                popularity: 72
            },
            {
                id: 'food',
                name: 'Food Truck Festival',
                category: 'food',
                lat: 40.7356,
                lng: -73.9906,
                address: 'Union Square, New York, NY 10003',
                time: '12:00 PM',
                price: 'Varies',
                description: 'Local food trucks serving diverse cuisines',
                popularity: 90
            },
            {
                id: 'comedy',
                name: 'Comedy Show at The Comedy Cellar',
                category: 'comedy',
                lat: 40.7306,
                lng: -73.9983,
                address: '117 MacDougal St, New York, NY 10012',
                time: '9:30 PM',
                price: '$20',
                description: 'Stand-up comedy featuring local comedians',
                popularity: 78
            },
            {
                id: 'yoga',
                name: 'Free Yoga in the Park',
                category: 'free',
                lat: 40.7308,
                lng: -73.9973,
                address: 'Washington Square Park, New York, NY 10012',
                time: '7:00 AM',
                price: 'Free',
                description: 'Morning yoga session in the park',
                popularity: 65
            }
        ];

        let currentMap = 'leaflet';
        let leafletMap = null;
        let mapboxMap = null;
        let markers = [];
        let filteredEvents = events;
        let animationsEnabled = true;
        let is3D = false;

        // Initialize the application
        function init() {
            // Hide loading
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 2000);

            // Initialize Leaflet map
            initLeafletMap();
            
            // Populate events list
            populateEventsList();
            
            // Add search functionality
            addSearchFunctionality();
            
            console.log('Advanced Leaflet + Mapbox GL map loaded!');
        }

        // Initialize Leaflet map
        function initLeafletMap() {
            leafletMap = L.map('map').setView([40.7282, -73.9857], 13);

            // Add Mapbox tiles to Leaflet
            L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=' + MAPBOX_TOKEN, {
                attribution: '¬© Mapbox ¬© OpenStreetMap',
                maxZoom: 18
            }).addTo(leafletMap);

            addLeafletMarkers();
        }

        // Initialize Mapbox GL map
        function initMapboxMap() {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            mapboxMap = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-73.9857, 40.7282],
                zoom: 13,
                pitch: is3D ? 45 : 0,
                bearing: is3D ? -17.6 : 0
            });

            mapboxMap.on('load', () => {
                addMapboxMarkers();
            });
        }

        // Add Leaflet markers
        function addLeafletMarkers() {
            markers = [];
            
            filteredEvents.forEach(event => {
                const icon = createLeafletIcon(event);
                const marker = L.marker([event.lat, event.lng], { icon })
                    .addTo(leafletMap)
                    .bindPopup(createPopupContent(event));

                marker.addListener('click', () => {
                    if (animationsEnabled) {
                        marker.getElement().classList.add('bounce');
                        setTimeout(() => {
                            marker.getElement().classList.remove('bounce');
                        }, 2000);
                    }
                });

                markers.push(marker);
            });
        }

        // Add Mapbox markers
        function addMapboxMarkers() {
            markers = [];
            
            filteredEvents.forEach(event => {
                const el = createMapboxMarkerElement(event);
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat([event.lng, event.lat])
                    .setPopup(new mapboxgl.Popup().setHTML(createPopupContent(event)))
                    .addTo(mapboxMap);

                el.addEventListener('click', () => {
                    if (animationsEnabled) {
                        el.classList.add('pulse');
                        setTimeout(() => {
                            el.classList.remove('pulse');
                        }, 2000);
                    }
                });

                markers.push(marker);
            });
        }

        // Create Leaflet icon
        function createLeafletIcon(event) {
            const color = getCategoryColor(event.category);
            const emoji = getCategoryEmoji(event.category);
            
            return L.divIcon({
                className: 'custom-leaflet-marker',
                html: `
                    <div style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: ${color};
                        border: 4px solid white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        color: white;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">${emoji}</div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        // Create Mapbox marker element
        function createMapboxMarkerElement(event) {
            const color = getCategoryColor(event.category);
            const emoji = getCategoryEmoji(event.category);
            
            const el = document.createElement('div');
            el.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: ${color};
                border: 4px solid white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                color: white;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            el.textContent = emoji;
            
            return el;
        }

        // Create popup content
        function createPopupContent(event) {
            const color = getCategoryColor(event.category);
            const emoji = getCategoryEmoji(event.category);
            
            return `
                <div style="
                    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
                    color: #1d1d1f;
                    min-width: 280px;
                    max-width: 320px;
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 16px;
                    ">
                        <div style="
                            width: 50px;
                            height: 50px;
                            background: ${color};
                            border-radius: 25px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            color: white;
                            box-shadow: 0 4px 20px ${color}40;
                        ">
                            ${emoji}
                        </div>
                        <div>
                            <h3 style="
                                margin: 0 0 8px 0;
                                font-size: 18px;
                                font-weight: 700;
                                color: #1d1d1f;
                            ">
                                ${event.name}
                            </h3>
                            <div style="
                                display: flex;
                                gap: 8px;
                                flex-wrap: wrap;
                            ">
                                <span style="
                                    background: ${color};
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 16px;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">
                                    ${event.category.toUpperCase()}
                                </span>
                                <span style="
                                    background: ${event.price === 'Free' ? '#34C759' : '#FF3B30'};
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 16px;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">
                                    ${event.price}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="
                        margin: 0 0 12px 0;
                        font-size: 14px;
                        color: #86868b;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <span style="font-size: 16px;">üïê</span>
                        <span>${event.time}</span>
                    </div>
                    
                    <div style="
                        margin: 0 0 16px 0;
                        font-size: 14px;
                        color: #86868b;
                        display: flex;
                        align-items: flex-start;
                        gap: 8px;
                    ">
                        <span style="font-size: 16px;">üìç</span>
                        <span style="line-height: 1.4;">${event.address}</span>
                    </div>
                    
                    <p style="
                        margin: 0 0 16px 0;
                        font-size: 14px;
                        color: #1d1d1f;
                        line-height: 1.5;
                    ">
                        ${event.description}
                    </p>
                    
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background: rgba(0, 0, 0, 0.02);
                        border-radius: 12px;
                        font-size: 12px;
                        color: #86868b;
                    ">
                        <span>Popularity: ${event.popularity}%</span>
                        <span>${currentMap.toUpperCase()} Map</span>
                    </div>
                </div>
            `;
        }

        // Switch between map types
        function switchMap(type) {
            currentMap = type;
            
            // Update button states
            document.getElementById('leafletBtn').classList.toggle('active', type === 'leaflet');
            document.getElementById('mapboxBtn').classList.toggle('active', type === 'mapbox');
            document.getElementById('mapType').textContent = type === 'leaflet' ? 'Leaflet' : 'Mapbox GL';
            
            // Clear existing map
            document.getElementById('map').innerHTML = '';
            markers = [];
            
            if (type === 'leaflet') {
                initLeafletMap();
            } else {
                initMapboxMap();
            }
        }

        // Toggle 3D view (Mapbox only)
        function toggle3D() {
            if (currentMap !== 'mapbox') {
                alert('3D view is only available with Mapbox GL maps. Switch to Mapbox GL first.');
                return;
            }
            
            is3D = !is3D;
            document.getElementById('3dBtn').classList.toggle('active', is3D);
            document.getElementById('3dStatus').textContent = is3D ? 'On' : 'Off';
            
            if (mapboxMap) {
                mapboxMap.easeTo({
                    pitch: is3D ? 45 : 0,
                    bearing: is3D ? -17.6 : 0,
                    duration: 1000
                });
            }
        }

        // Toggle animations
        function toggleAnimations() {
            animationsEnabled = !animationsEnabled;
            document.getElementById('animBtn').classList.toggle('active', animationsEnabled);
            document.getElementById('animStatus').textContent = animationsEnabled ? 'On' : 'Off';
        }

        // Filter events
        function filterEvents(category) {
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            filteredEvents = category === 'all' ? events : events.filter(e => e.category === category);
            
            // Update markers
            if (currentMap === 'leaflet') {
                leafletMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        leafletMap.removeLayer(layer);
                    }
                });
                addLeafletMarkers();
            } else if (mapboxMap) {
                markers.forEach(marker => marker.remove());
                addMapboxMarkers();
            }

            populateEventsList();
            updateStats();
        }

        // Populate events list
        function populateEventsList() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';

            filteredEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.onclick = () => {
                    if (currentMap === 'leaflet') {
                        leafletMap.setView([event.lat, event.lng], 16);
                        markers[filteredEvents.indexOf(event)].openPopup();
                    } else if (mapboxMap) {
                        mapboxMap.flyTo({
                            center: [event.lng, event.lat],
                            zoom: 16,
                            duration: 1000
                        });
                        markers[filteredEvents.indexOf(event)].togglePopup();
                    }
                };

                eventDiv.innerHTML = `
                    <div class="event-category category-${event.category}">${getCategoryEmoji(event.category)} ${event.category.toUpperCase()}</div>
                    <div class="event-title">${event.name}</div>
                    <div class="event-details">
                        <div class="event-meta">
                            <span>üïê ${event.time}</span>
                            <span>üí∞ ${event.price}</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #86868b;">
                            üìç ${event.address}
                        </div>
                        <div style="margin-top: 4px; font-size: 12px; color: #007AFF;">
                            Popularity: ${event.popularity}%
                        </div>
                    </div>
                `;

                eventsList.appendChild(eventDiv);
            });
        }

        // Add search functionality
        function addSearchFunctionality() {
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = events.filter(event => 
                    event.name.toLowerCase().includes(query) ||
                    event.description.toLowerCase().includes(query) ||
                    event.category.toLowerCase().includes(query) ||
                    event.address.toLowerCase().includes(query)
                );
                
                filteredEvents = filtered;
                populateEventsList();
                updateStats();
            });
        }

        // Update stats
        function updateStats() {
            document.getElementById('eventCount').textContent = filteredEvents.length;
        }

        // Helper functions
        function getCategoryColor(category) {
            const colors = {
                'music': 'linear-gradient(135deg, #FF3B30, #FF6B6B)',
                'art': 'linear-gradient(135deg, #007AFF, #5AC8FA)',
                'food': 'linear-gradient(135deg, #34C759, #30D158)',
                'comedy': 'linear-gradient(135deg, #FF9500, #FFB84D)',
                'free': 'linear-gradient(135deg, #FFCC00, #FFD60A)'
            };
            return colors[category] || 'linear-gradient(135deg, #86868b, #A8A8A8)';
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'music': 'üéµ',
                'art': 'üé®',
                'food': 'üçΩÔ∏è',
                'comedy': 'üòÇ',
                'free': 'üÜì'
            };
            return emojis[category] || 'üìç';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
